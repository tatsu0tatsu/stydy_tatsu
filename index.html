<html>
<head>
<title>sample</title>
<link rel="stylesheet" href="./css/style.css">
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js" crossorigin="anonymous"></script>

<script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/pose/pose.js" crossorigin="anonymous"></script>
<script src="./js/pose.js"></script>

</head>
<body>
    <main>
        <section style="width:800px;margin:0 auto;overflow:hidden;">
            <div style="float:left;width:360px;height:440px;border:solid 1px #000;">

                <video src="./video/side.mp4" id="v" width="360" style="display:none;"></video>
                <canvas id="c" width="360" height="440"></canvas>

            </div>
            <div style="float:right;width:360px;height:440px;border:solid 1px #000;">
                <video class="input_video" style="display:none;"></video>
                <canvas class="output_canvas" width="360px" height="440px"></canvas>
                <div id="start" onclick="start();">start</div>
                <div id="stop" onclick="stop();">stop</div>
            </div>
        </section>
        <section style="clear:both;width:800px;margin:0 auto;margin-top:30px;">
            <div style="width:800px;border:solid 1px #000;height:300px;">
                <p>canvas</p>
            </div>
        </section>
    
        
    </main>
    

</body>
</html>

<script>

    var v = document.getElementById('v');
    v.muted = true;
    var v_flag=0;

    var v_canvas=document.getElementById('c');
    v_context=v_canvas.getContext("2d");

    v.addEventListener('play', function() {
    console.log("start");
    const intervalId=setInterval(()=>{
    v_pri(v);
    if(v_flag==1){
        clearInterval(intervalId);
    }},100);

    })
    v.addEventListener('ended', function() {
    console.log("end");
    v_flag=1;
    })

    v.play();

    
function v_pri(v){

pose1.send({image:v});
    console.log("go");
}



const videoElement = document.getElementsByClassName('input_video')[0];
const canvasElement = document.getElementsByClassName('output_canvas')[0];
const canvasCtx = canvasElement.getContext('2d');
const camera = new Camera(videoElement, {
    onFrame: async () => {
        await pose.send({image: videoElement});
    },
      width: 360,
      height: 440
});

function start(){
    console.log("start");
    camera.start();
}function stop(){
    console.log("stop");
    camera.stop();
}

function onResults(results) {
  canvasCtx.save();
  canvasCtx.clearRect(0, 0, canvasElement.width, canvasElement.height);
  canvasCtx.drawImage(results.image, 0, 0, canvasElement.width, canvasElement.height);
  drawConnectors(canvasCtx, results.poseLandmarks, POSE_CONNECTIONS,
                 {color: '#ffffff', lineWidth: 4});
  drawLandmarks(canvasCtx, results.poseLandmarks,
                {color: '#ffddff', lineWidth: 2});
  canvasCtx.restore();
}

const pose = new Pose({locateFile: (file) => {
      return `https://cdn.jsdelivr.net/npm/@mediapipe/pose/${file}`;
}});
pose.setOptions({
      modelComplexity: 1,
      smoothLandmarks: true,
      enableSegmentation: true,
      smoothSegmentation: true,
      minDetectionConfidence: 0.5,
      minTrackingConfidence: 0.5
});
pose.onResults(onResults);

function onResults1(results) {

    var point1=[results.poseLandmarks[13].x,results.poseLandmarks[13].y];
    var point2=[results.poseLandmarks[11].x,results.poseLandmarks[11].y];
    var point3=[results.poseLandmarks[23].x,results.poseLandmarks[23].y];
    
    var va=[point1[0]-point2[0],point1[1]-point2[1]];
    var vb=[point3[0]-point2[0],point3[1]-point2[1]];

    var dot=va[0]*vb[0]+va[1]*vb[1];
    var absa=Math.sqrt(va[0]*va[0]+va[1]*va[1]);
    var absb=Math.sqrt(vb[0]*vb[0]+vb[1]*vb[1]);

    var ans=Math.acos(dot/(absa*absb))*(180 / Math.PI);
    console.log(ans);
/* 
    var res=(va1*va2+vb1*vb2)/(Math.sqrt(va1*va1+va2*va2)*Math.sqrt(vb1*vb1+vb2*vb2));
    res=Math.acos(res)*(180/Math.PI);
    console.log(res);*/

    v_context.save();
    v_context.clearRect(0, 0, v_canvas.width, v_canvas.height);
    v_context.drawImage(results.image, 0, 0, v_canvas.width, v_canvas.height);
  drawConnectors(v_context, results.poseLandmarks, POSE_CONNECTIONS,
                 {color: '#ffffff', lineWidth: 4});
  drawLandmarks(v_context, results.poseLandmarks,
                {color: '#ffddff', lineWidth: 2});
  v_context.restore();
}

const pose1 = new Pose({locateFile: (file) => {
      return `https://cdn.jsdelivr.net/npm/@mediapipe/pose/${file}`;
}});
pose1.setOptions({
      modelComplexity: 1,
      smoothLandmarks: true,
      enableSegmentation: true,
      smoothSegmentation: true,
      minDetectionConfidence: 0.5,
      minTrackingConfidence: 0.5
});
pose1.onResults(onResults1);



</script>

